<div class="w-full max-w-[1200px] mb-8" id="instructor-wrapper" data-field-id="{{ field.vars.id }}">
	<label class="block mb-2 text-sm font-medium text-gray-700">
		{{ field.vars.label|default("Intervenants - champ obligatoire") }}
	</label>

	<div id="modal-trigger" class="flex items-center justify-between p-2 bg-white border border-gray-300 rounded-md shadow-sm cursor-pointer hover:border-zinc-400 min-h-[46px] relative transition-all">

		<div class="flex flex-wrap items-center gap-2 flex-1">
			<div id="chips-container" class="flex flex-wrap gap-2"></div>
			<span id="placeholder-text" class="text-zinc-400 text-sm ml-1">Cliquer pour sélectionner...</span>
		</div>

		<div class="flex-shrink-0 ml-2 pr-1">
			<svg class="w-4 h-4 text-zinc-400" fill="none" stroke="currentColor" viewbox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
			</svg>
		</div>
	</div>

	<div class="hidden">
		{{ form_widget(field) }}
	</div>
</div>

<div id="instructor-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
	<div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh]">

		<div class="p-4 border-b border-zinc-100 flex justify-between items-center bg-zinc-50">
			<h3 class="font-bold text-zinc-800 text-lg">Choisir les intervenants</h3>
			<button type="button" class="close-modal text-zinc-400 hover:text-zinc-800 text-2xl p-2">&times;</button>
		</div>

		<div class="p-2 overflow-y-auto flex-1 bg-white">
			{% for choice in field.vars.choices %}
				<label class="flex items-center p-3 hover:bg-zinc-100 rounded-lg cursor-pointer transition-colors group">
					<input type="checkbox" value="{{ choice.value }}" data-label="{{ choice.label }}" class="instructor-checkbox w-5 h-5 text-zinc-800 border-zinc-300 rounded focus:ring-zinc-500 cursor-pointer">
					<span class="ml-3 text-zinc-700 group-hover:text-black font-medium text-sm">{{ choice.label }}</span>
				</label>
			{% endfor %}
		</div>

		<div class="p-4 bg-zinc-50 border-t border-zinc-100 flex justify-end gap-3">
			<button type="button" class="close-modal px-4 py-2 text-sm font-medium text-zinc-600 hover:bg-zinc-200 rounded-lg">Annuler</button>
			<button type="button" id="confirm-selection" class="px-6 py-2 text-sm font-bold text-white bg-zinc-800 hover:bg-black rounded-lg shadow-md transition-all active:scale-95">Valider</button>
		</div>
	</div>
</div>
<script>
	// Champs multi_select formulaire
document.addEventListener('DOMContentLoaded', function () {
const wrapper = document.getElementById('instructor-wrapper');
if (! wrapper) 
return;



// Sécurité si l'élément n'est pas sur la page

const fieldId = wrapper.getAttribute('data-field-id');
const realSelect = document.getElementById(fieldId);

const modal = document.getElementById('instructor-modal');
const trigger = document.getElementById('modal-trigger');
const closeButtons = document.querySelectorAll('.close-modal');
const confirmBtn = document.getElementById('confirm-selection');
const chipsContainer = document.getElementById('chips-container');
const placeholder = document.getElementById('placeholder-text');
const checkboxes = document.querySelectorAll('.instructor-checkbox');

// Ouverture modale
trigger.addEventListener('click', (e) => {
if (!e.target.closest('.remove-chip-btn')) {
modal.classList.remove('hidden');
document.body.style.overflow = 'hidden';
}
});

// Fermer la modale au clic sur l'arrière-plan (en dehors de la boîte blanche)
modal.addEventListener('click', (e) => {
// Si l'élément cliqué est exactement le conteneur 'instructor-modal'
// (le fond noir transparent) et non son contenu blanc
if (e.target === modal) {
closeModal();
}
});

// Fermeture modale
const closeModal = () => {
modal.classList.add('hidden');
document.body.style.overflow = '';
syncCheckboxesFromRealSelect();
};

closeButtons.forEach(btn => btn.addEventListener('click', closeModal));

confirmBtn.addEventListener('click', () => {
updateEverything();
modal.classList.add('hidden');
document.body.style.overflow = '';
});

function updateEverything() {
chipsContainer.innerHTML = '';
const selectedValues = [];

checkboxes.forEach(cb => {
if (cb.checked) {
selectedValues.push(cb.value);
createChip(cb.value, cb.getAttribute('data-label'));
}
});

Array.from(realSelect.options).forEach(opt => {
opt.selected = selectedValues.includes(opt.value);
});

placeholder.style.display = selectedValues.length > 0 ? 'none' : 'block';
}

function createChip(id, name) {
const chip = document.createElement('div');
chip.className = "flex items-center gap-2 px-3 py-1 text-sm font-medium text-white rounded-md shadow-sm";

// Style forcé pour éviter le bug du "tout blanc"
chip.style.backgroundColor = '#757575';
chip.style.color = '#ffffff';

const span = document.createElement('span');
span.textContent = name;

const btn = document.createElement('button');
btn.type = "button";
btn.innerHTML = "&times;";
btn.className = "remove-chip-btn hover:text-red-300 focus:outline-none leading-none text-lg transition-colors ml-1 text-white";

btn.addEventListener('click', (e) => {
e.preventDefault();
e.stopPropagation();
removeInstructorSelection(id);
});

chip.appendChild(span);
chip.appendChild(btn);
chipsContainer.appendChild(chip);
}

function removeInstructorSelection(id) {
const cb = document.querySelector(`.instructor-checkbox[value="${id}"]`);
if (cb) 
cb.checked = false;



updateEverything();
}

function syncCheckboxesFromRealSelect() {
const currentValues = Array.from(realSelect.selectedOptions).map(o => o.value);
checkboxes.forEach(cb => {
cb.checked = currentValues.includes(cb.value);
});
}

// Initialisation
syncCheckboxesFromRealSelect();
updateEverything();
});
</script>
