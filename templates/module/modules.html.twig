{% extends 'base.html.twig' %}

{% block title %}
    Modules
{% endblock %}

{% block body %}
<div class="container mt-4 mb-4">
    <h1 class="font-medium text-[#1F384C] text-[26px] mb-[10px]">
        Modules
	</h1>

    {% for block in blocks %}
        <div class="border-2 border-dashed border-gray-400/20 rounded-2xl p-4 mb-8 w-300 gap-6">
            
            <h3 class="text-[#FFBD01] font-medium text-[20px] pb-[10px]"">
                {{ block.code }} : {{ block.description  }} 
                <span class="text-[#FFBD01] text-lg font-medium">({{ block.hoursCount|default(0) }})h</span>
            </h3>

            <div class="mt-3 pl-3">
                {% for module in block.modules %}
                    {% if module.parent is null %}
                        {{ _self.display_tree(module) }}
                    {% endif %}

                {% else %}
                    <p class="text-muted">Aucun module.</p>
                {% endfor %}
            </div>
        </div>
        <div class="mt-3 my-10">
            <a href="{{ path('app_module_new', {'block_id': block.id}) }}" class="text-white bg-[#1e293b] hover:bg-slate-800 
            focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
        Ajouter un module
    </a>
        </div>
    {% endfor %}
</div>

{# MACRO #}
{% macro display_tree(module) %}
    {% import _self as macros %}
    
    <div class="tree-item group">
        <div class="flex items-center relative h-9">
            
            {# Zone de l'icône / Toggle - Toujours présente #}
            <div class="icon-wrapper mr-1">
                <button onclick="toggleTree(this)" class="transition-transform duration-200 ease-in-out">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-3 h-3 text-slate-400 arrow-icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                    </svg>
                </button>
            </div>

            {# Label du module #}
            <a href="{{ path('app_module_edit', {id: module.id}) }}" class="flex items-center text-slate-700 hover:text-indigo-600 px-1 text-sm transition-colors">
                <span class="font-semibold">{{ module.name }}</span>
                {% if module.hoursCount %}
                    <span class="ml-1 text-slate-400 font-normal">({{ module.hoursCount }}h)</span>
                {% endif %}
            </a>
        </div>

        {# Conteneur des enfants - Toujours présent dans le DOM pour le toggle #}
        <div class="sub-tree hidden">
            {% if module.children is not empty %}
                {% for child in module.children %}
                    <div class="tree-node relative">
                        {{ macros.display_tree(child) }}
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
{% endmacro %}

<script>
function toggleTree(button) {
    // On trouve le conteneur sub-tree le plus proche
    const parentItem = button.closest('.tree-item');
    const subTree = parentItem.querySelector('.sub-tree');
    const arrow = button.querySelector('.arrow-icon');

    if (subTree) {
        // Toggle de l'affichage
        subTree.classList.toggle('hidden');
        // Rotation de la flèche
        arrow.classList.toggle('arrow-rotate');
    }
}
</script>

{% endblock %}
